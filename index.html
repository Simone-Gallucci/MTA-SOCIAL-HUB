<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MTA Social Hub - Marketplace</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Payment Configuration -->
    <script src="config.js"></script>
    <!-- Stripe.js -->
    <script src="https://js.stripe.com/v3/"></script>
    <!-- PayPal SDK -->
    <script src="https://www.paypal.com/sdk/js?client-id=YOUR_PAYPAL_CLIENT_ID&currency=EUR"></script>
</head>
<body>
    <div id="app">
        <!-- Header -->
        <header class="header">
            <div class="container">
                <h1 class="logo">üõçÔ∏è MTA Social Hub</h1>
                <nav class="nav">
                    <button @click="showProducts" :class="{ active: currentPage === 'products' }" class="nav-btn">
                        Prodotti
                    </button>
                    <button @click="showCart" :class="{ active: currentPage === 'cart' }" class="nav-btn">
                        Carrello <span class="cart-count" v-if="cartItems.length > 0">({{ cartItems.length }})</span>
                    </button>
                </nav>
            </div>
        </header>

        <!-- Pagina Prodotti -->
        <main v-if="currentPage === 'products'" class="products-page">
            <div class="container">
                <h2>I Nostri Prodotti</h2>
                <div class="products-grid">
                    <div v-for="product in products" :key="product.id" class="product-card">
                        <img :src="product.image" :alt="product.name" class="product-image">
                        <div class="product-info">
                            <h3 class="product-name">{{ product.name }}</h3>
                            <p class="product-description">{{ product.description }}</p>
                            <div class="product-footer">
                                <span class="product-price">‚Ç¨{{ product.price.toFixed(2) }}</span>
                                <button @click="addToCart(product)" class="add-to-cart-btn">
                                    Aggiungi al Carrello
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Pagina Carrello -->
        <main v-if="currentPage === 'cart'" class="cart-page">
            <div class="container">
                <h2>Il Tuo Carrello</h2>
                <div v-if="cartItems.length === 0" class="empty-cart">
                    <p>Il tuo carrello √® vuoto</p>
                    <button @click="showProducts" class="continue-shopping-btn">
                        Continua gli Acquisti
                    </button>
                </div>
                <div v-else class="cart-content">
                    <div class="cart-items">
                        <div v-for="item in cartItems" :key="item.id" class="cart-item">
                            <img :src="item.image" :alt="item.name" class="cart-item-image">
                            <div class="cart-item-info">
                                <h3 class="cart-item-name">{{ item.name }}</h3>
                                <p class="cart-item-description">{{ item.description }}</p>
                            </div>
                            <div class="cart-item-controls">
                                <div class="quantity-controls">
                                    <button @click="decreaseQuantity(item)" class="qty-btn">-</button>
                                    <span class="quantity">{{ item.quantity }}</span>
                                    <button @click="increaseQuantity(item)" class="qty-btn">+</button>
                                </div>
                                <span class="cart-item-price">‚Ç¨{{ (item.price * item.quantity).toFixed(2) }}</span>
                                <button @click="removeFromCart(item)" class="remove-btn">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>
                    <div class="cart-summary">
                        <div class="total">
                            <strong>Totale: ‚Ç¨{{ cartTotal.toFixed(2) }}</strong>
                        </div>
                        <button @click="showCheckout" class="checkout-btn">
                            Procedi al Checkout
                        </button>
                        <button @click="showProducts" class="continue-shopping-btn">
                            Continua gli Acquisti
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Pagina Checkout -->
        <main v-if="currentPage === 'checkout'" class="checkout-page">
            <div class="container">
                <h2>Checkout</h2>
                <div class="checkout-content">
                    <div class="checkout-form">
                        <h3>Dati di Fatturazione</h3>
                        <form @submit.prevent="processCheckout">
                            <div class="form-group">
                                <label for="firstName">Nome *</label>
                                <input type="text" id="firstName" v-model="checkoutForm.firstName" required>
                            </div>
                            <div class="form-group">
                                <label for="lastName">Cognome *</label>
                                <input type="text" id="lastName" v-model="checkoutForm.lastName" required>
                            </div>
                            <div class="form-group">
                                <label for="email">Email *</label>
                                <input type="email" id="email" v-model="checkoutForm.email" required>
                            </div>
                            <div class="form-group">
                                <label for="phone">Telefono *</label>
                                <input type="tel" id="phone" v-model="checkoutForm.phone" required>
                            </div>
                            
                            <h3>Modalit√† di Consegna</h3>
                            <div class="delivery-methods">
                                <div class="delivery-option">
                                    <input type="radio" id="delivery" v-model="checkoutForm.deliveryMethod" value="delivery" checked>
                                    <label for="delivery">üöö Consegna a Domicilio</label>
                                    <p class="delivery-description">Ricevi il prodotto comodamente a casa tua</p>
                                </div>
                                <!-- 
                                <div class="delivery-option">
                                    <input type="radio" id="pickup" v-model="checkoutForm.deliveryMethod" value="pickup">
                                    <label for="pickup">üè¢ Ritiro presso Centro MTA</label>
                                    <p class="delivery-description">Ritira il prodotto presso il nostro centro</p>
                                </div>
                                -->
                            </div>

                            <div v-if="checkoutForm.deliveryMethod === 'delivery'" class="address-section">
                                <h4>Indirizzo di Consegna</h4>
                                <div class="form-group">
                                    <label for="address">Indirizzo *</label>
                                    <input type="text" id="address" v-model="checkoutForm.address" 
                                           :required="checkoutForm.deliveryMethod === 'delivery'">
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="city">Citt√† *</label>
                                        <input type="text" id="city" v-model="checkoutForm.city" 
                                               :required="checkoutForm.deliveryMethod === 'delivery'">
                                    </div>
                                    <div class="form-group">
                                        <label for="cap">CAP *</label>
                                        <input type="text" id="cap" v-model="checkoutForm.cap" 
                                               :required="checkoutForm.deliveryMethod === 'delivery'" pattern="[0-9]{5}">
                                    </div>
                                </div>
                            </div>

                            <!-- 
                            <div v-if="checkoutForm.deliveryMethod === 'pickup'" class="pickup-info">
                                <div class="info-box">
                                    <h4>üìç Informazioni Ritiro</h4>
                                    <p><strong>Indirizzo:</strong> Via Centro MTA, 123 - 00100 Roma</p>
                                    <p><strong>Orari:</strong> Lun-Ven: 9:00-18:00, Sab: 9:00-13:00</p>
                                    <p><strong>Telefono:</strong> +39 06 123456789</p>
                                    <p class="note">üí° Porta con te un documento d'identit√† e il codice ordine</p>
                                </div>
                            </div>
                            -->
                            
                            <h3>Metodo di Pagamento</h3>
                            <div class="payment-methods">
                                <div class="payment-option">
                                    <input type="radio" id="stripe" v-model="checkoutForm.paymentMethod" value="stripe" checked>
                                    <label for="stripe">üí≥ Carta di Credito/Debito (Stripe)</label>
                                    <p class="payment-description">Pagamento sicuro con Stripe - Visa, Mastercard, American Express</p>
                                </div>
                                <div class="payment-option">
                                    <input type="radio" id="paypal" v-model="checkoutForm.paymentMethod" value="paypal">
                                    <label for="paypal">ÔøΩÔ∏è PayPal</label>
                                    <p class="payment-description">Paga con il tuo account PayPal o carta tramite PayPal</p>
                                </div>
                                <div class="payment-option">
                                    <input type="radio" id="bank" v-model="checkoutForm.paymentMethod" value="bank">
                                    <label for="bank">üè¶ Bonifico Bancario</label>
                                    <p class="payment-description">Trasferimento bancario tradizionale (1-3 giorni lavorativi)</p>
                                </div>
                            </div>

                            <!-- Stripe Payment -->
                            <div v-if="checkoutForm.paymentMethod === 'stripe'" class="stripe-details">
                                <p class="payment-note">üí≥ Pagamento sicuro elaborato da Stripe:</p>
                                <div id="stripe-card-element" class="stripe-element">
                                    <!-- Stripe Elements creer√† automaticamente i campi della carta qui -->
                                </div>
                                <div id="stripe-card-errors" class="stripe-errors" role="alert"></div>
                                <div class="stripe-info">
                                    <p class="security-note">üîí <strong>Sicurezza massima:</strong> Stripe elabora i pagamenti in conformit√† agli standard PCI DSS. I tuoi dati non vengono mai memorizzati sui nostri server.</p>
                                    <p class="accepted-cards">üí≥ <strong>Carte accettate:</strong> Visa, Mastercard, American Express, Discover</p>
                                </div>
                            </div>

                            <!-- PayPal Payment -->
                            <div v-if="checkoutForm.paymentMethod === 'paypal'" class="paypal-details">
                                <p class="payment-note">üÖøÔ∏è Pagamento con PayPal:</p>
                                <div id="paypal-button-container" class="paypal-container">
                                    <!-- I pulsanti PayPal verranno inseriti qui -->
                                </div>
                                <div class="paypal-info">
                                    <p class="security-note">üîí <strong>Protezione acquirenti PayPal:</strong> I tuoi acquisti sono protetti dalla Garanzia PayPal.</p>
                                    <p>üí° Puoi pagare con il tuo saldo PayPal, carta di credito o conto bancario collegato.</p>
                                </div>
                            </div>

                            <div v-if="checkoutForm.paymentMethod === 'bank'" class="bank-details">
                                <p class="payment-note">üè¶ Collegamento con il tuo conto bancario:</p>
                                <div class="bank-connection">
                                    <div class="form-group">
                                        <label for="bankName">Seleziona la tua Banca *</label>
                                        <select id="bankName" v-model="checkoutForm.bankName" required>
                                            <option value="">-- Scegli la tua banca --</option>
                                            <option value="intesa">Intesa Sanpaolo</option>
                                            <option value="unicredit">UniCredit</option>
                                            <option value="bnl">BNL - Gruppo BNP Paribas</option>
                                            <option value="montepaschi">Monte dei Paschi di Siena</option>
                                            <option value="banco_bpm">Banco BPM</option>
                                            <option value="poste">Poste Italiane</option>
                                            <option value="mediolanum">Mediolanum Bank</option>
                                            <option value="fineco">FinecoBank</option>
                                            <option value="ing">ING Direct</option>
                                            <option value="n26">N26</option>
                                            <option value="revolut">Revolut</option>
                                            <option value="other">Altra banca</option>
                                        </select>
                                    </div>
                                    <div v-if="checkoutForm.bankName === 'other'" class="form-group">
                                        <label for="customBankName">Nome della tua Banca *</label>
                                        <input type="text" id="customBankName" v-model="checkoutForm.customBankName" 
                                               placeholder="Inserisci il nome della banca" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="iban">IBAN *</label>
                                        <input type="text" id="iban" v-model="checkoutForm.iban" 
                                               placeholder="IT60 X054 2811 1010 0000 0123 456" 
                                               @input="formatIban" maxlength="32" required>
                                        <small class="form-help">Inserisci il tuo IBAN per il bonifico istantaneo</small>
                                    </div>
                                    <div class="bank-info">
                                        <div class="info-item">
                                            <strong>üí° Come funziona:</strong>
                                            <p>1. Inserisci i tuoi dati bancari in modo sicuro</p>
                                            <p>2. Autorizza il bonifico istantaneo dal tuo conto</p>
                                            <p>3. Il pagamento viene elaborato immediatamente</p>
                                            <p>4. Riceverai conferma via email e SMS</p>
                                        </div>
                                        <div class="security-note">
                                            <p>üîí <strong>Sicurezza garantita:</strong> I tuoi dati bancari sono crittografati e non vengono memorizzati sui nostri server.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="form-actions">
                                <button type="button" @click="showCart" class="btn-secondary">
                                    Torna al Carrello
                                </button>
                                <button type="submit" class="btn-primary" :disabled="isProcessing">
                                    <span v-if="isProcessing">Elaborando...</span>
                                    <span v-else>Conferma Ordine - ‚Ç¨{{ cartTotal.toFixed(2) }}</span>
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <div class="order-summary">
                        <h3>Riepilogo Ordine</h3>
                        <div class="summary-items">
                            <div v-for="item in cartItems" :key="item.id" class="summary-item">
                                <span class="item-name">{{ item.name }} x{{ item.quantity }}</span>
                                <span class="item-price">‚Ç¨{{ (item.price * item.quantity).toFixed(2) }}</span>
                            </div>
                        </div>
                        <div class="summary-total">
                            <strong>Totale: ‚Ç¨{{ cartTotal.toFixed(2) }}</strong>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Notifiche -->
        <div v-if="notification" class="notification" :class="notification.type">
            {{ notification.message }}
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    currentPage: 'products',
                    products: [],
                    cartItems: [],
                    notification: null,
                    isProcessing: false,
                    checkoutForm: {
                        firstName: '',
                        lastName: '',
                        email: '',
                        phone: '',
                        address: '',
                        city: '',
                        cap: '',
                        deliveryMethod: 'delivery',
                        paymentMethod: 'stripe',
                        bankName: '',
                        customBankName: '',
                        iban: ''
                    },
                    stripe: null,
                    stripeCard: null,
                    paypalRendered: false
                }
            },
            computed: {
                cartTotal() {
                    return this.cartItems.reduce((total, item) => total + (item.price * item.quantity), 0);
                }
            },
            methods: {
                loadProducts() {
                    // Dati prodotti integrati direttamente nel codice (nessun server necessario)
                    this.products = [
                        {
                            id: 1,
                            name: "Smartphone Samsung Galaxy",
                            price: 599.99,
                            image: "https://via.placeholder.com/200x200/007BFF/FFFFFF?text=Samsung",
                            description: "Smartphone di ultima generazione con fotocamera avanzata"
                        },
                        {
                            id: 2,
                            name: "Laptop Dell XPS",
                            price: 1299.99,
                            image: "https://via.placeholder.com/200x200/28A745/FFFFFF?text=Dell",
                            description: "Laptop professionale con processore Intel i7"
                        },
                        {
                            id: 3,
                            name: "Auricolari Wireless",
                            price: 79.99,
                            image: "https://via.placeholder.com/200x200/FFC107/FFFFFF?text=Auricolari",
                            description: "Auricolari wireless con cancellazione del rumore"
                        },
                        {
                            id: 4,
                            name: "Tablet iPad Air",
                            price: 649.99,
                            image: "https://via.placeholder.com/200x200/DC3545/FFFFFF?text=iPad",
                            description: "Tablet leggero e potente per lavoro e intrattenimento"
                        },
                        {
                            id: 5,
                            name: "Smartwatch Apple",
                            price: 399.99,
                            image: "https://via.placeholder.com/200x200/6C757D/FFFFFF?text=Watch",
                            description: "Smartwatch con monitoraggio della salute"
                        },
                        {
                            id: 6,
                            name: "Speaker Bluetooth",
                            price: 129.99,
                            image: "https://via.placeholder.com/200x200/17A2B8/FFFFFF?text=Speaker",
                            description: "Speaker portatile con audio di alta qualit√†"
                        }
                    ];
                },
                showProducts() {
                    this.currentPage = 'products';
                    this.updateURL('index');
                },
                showCart() {
                    this.currentPage = 'cart';
                    this.updateURL('carrello');
                },
                showCheckout() {
                    this.currentPage = 'checkout';
                    this.updateURL('checkout');
                    
                    // Inizializza i servizi di pagamento quando si entra nel checkout
                    this.$nextTick(() => {
                        this.initializePaymentServices();
                    });
                },
                updateURL(page) {
                    // Simula il cambio di URL senza ricaricare la pagina (come AJAX)
                    window.history.pushState({}, '', `${page}.html`);
                },
                addToCart(product) {
                    const existingItem = this.cartItems.find(item => item.id === product.id);
                    if (existingItem) {
                        existingItem.quantity++;
                    } else {
                        this.cartItems.push({
                            ...product,
                            quantity: 1
                        });
                    }
                    this.saveCart();
                    this.showNotification(`${product.name} aggiunto al carrello!`, 'success');
                },
                removeFromCart(item) {
                    const index = this.cartItems.findIndex(cartItem => cartItem.id === item.id);
                    if (index !== -1) {
                        this.cartItems.splice(index, 1);
                        this.saveCart();
                        this.showNotification(`${item.name} rimosso dal carrello`, 'info');
                    }
                },
                increaseQuantity(item) {
                    item.quantity++;
                    this.saveCart();
                },
                decreaseQuantity(item) {
                    if (item.quantity > 1) {
                        item.quantity--;
                        this.saveCart();
                    } else {
                        this.removeFromCart(item);
                    }
                },
                saveCart() {
                    localStorage.setItem('mtaCart', JSON.stringify(this.cartItems));
                },
                loadCart() {
                    const savedCart = localStorage.getItem('mtaCart');
                    if (savedCart) {
                        this.cartItems = JSON.parse(savedCart);
                    }
                },
                showNotification(message, type = 'info') {
                    this.notification = { message, type };
                    setTimeout(() => {
                        this.notification = null;
                    }, 3000);
                },
                checkout() {
                    // Metodo deprecato - ora si usa showCheckout()
                    this.showCheckout();
                },
                processCheckout() {
                    if (!this.validateCheckoutForm()) {
                        return;
                    }
                    
                    this.isProcessing = true;
                    
                    // Elabora il pagamento in base al metodo selezionato
                    if (this.checkoutForm.paymentMethod === 'stripe') {
                        this.processStripePayment();
                    } else if (this.checkoutForm.paymentMethod === 'paypal') {
                        // PayPal gestisce il pagamento tramite i suoi pulsanti
                        this.showNotification('Completa il pagamento tramite PayPal', 'info');
                        this.isProcessing = false;
                    } else if (this.checkoutForm.paymentMethod === 'bank') {
                        this.processBankTransfer();
                    }
                },
                initializePaymentServices() {
                    this.initializeStripe();
                    this.initializePayPal();
                },
                initializeStripe() {
                    // Usa la configurazione dal file config.js
                    const stripeKey = window.PAYMENT_CONFIG?.stripe?.publicKey || 'pk_test_YOUR_STRIPE_PUBLIC_KEY';
                    
                    if (typeof Stripe !== 'undefined') {
                        this.stripe = Stripe(stripeKey);
                        const elements = this.stripe.elements();
                        
                        // Crea l'elemento carta
                        this.stripeCard = elements.create('card', {
                            style: {
                                base: {
                                    fontSize: '16px',
                                    color: '#424770',
                                    '::placeholder': {
                                        color: '#aab7c4',
                                    },
                                    padding: '12px',
                                },
                                invalid: {
                                    color: '#9e2146',
                                },
                            },
                        });
                        
                        // Monta l'elemento nel DOM
                        const cardElement = document.getElementById('stripe-card-element');
                        if (cardElement) {
                            this.stripeCard.mount('#stripe-card-element');
                            
                            // Gestisci gli errori real-time
                            this.stripeCard.on('change', ({error}) => {
                                const displayError = document.getElementById('stripe-card-errors');
                                if (error) {
                                    displayError.textContent = error.message;
                                } else {
                                    displayError.textContent = '';
                                }
                            });
                        }
                    } else {
                        console.error('Stripe.js non √® caricato');
                        this.showNotification('Servizio di pagamento non disponibile', 'error');
                    }
                },
                initializePayPal() {
                    if (typeof paypal !== 'undefined' && !this.paypalRendered) {
                        const container = document.getElementById('paypal-button-container');
                        if (container) {
                            // Svuota il container prima di renderizzare
                            container.innerHTML = '';
                            
                            paypal.Buttons({
                                createOrder: (data, actions) => {
                                    return actions.order.create({
                                        purchase_units: [{
                                            amount: {
                                                value: this.cartTotal.toFixed(2),
                                                currency_code: 'EUR'
                                            },
                                            description: `Ordine MTA Social Hub - ${this.cartItems.length} articoli`
                                        }]
                                    });
                                },
                                onApprove: (data, actions) => {
                                    return actions.order.capture().then((details) => {
                                        this.completeOrder({
                                            paymentMethod: 'paypal',
                                            transactionId: details.id,
                                            payerName: details.payer.name.given_name + ' ' + details.payer.name.surname,
                                            payerEmail: details.payer.email_address
                                        });
                                    });
                                },
                                onError: (err) => {
                                    console.error('Errore PayPal:', err);
                                    this.showNotification('Errore durante il pagamento PayPal', 'error');
                                    this.isProcessing = false;
                                },
                                style: {
                                    color: 'blue',
                                    shape: 'rect',
                                    label: 'paypal'
                                }
                            }).render('#paypal-button-container');
                            
                            this.paypalRendered = true;
                        }
                    }
                },
                async processStripePayment() {
                    if (!this.stripe || !this.stripeCard) {
                        this.showNotification('Servizio di pagamento non disponibile', 'error');
                        this.isProcessing = false;
                        return;
                    }
                    
                    // Crea il PaymentMethod
                    const {error, paymentMethod} = await this.stripe.createPaymentMethod({
                        type: 'card',
                        card: this.stripeCard,
                        billing_details: {
                            name: `${this.checkoutForm.firstName} ${this.checkoutForm.lastName}`,
                            email: this.checkoutForm.email,
                            phone: this.checkoutForm.phone,
                            address: {
                                line1: this.checkoutForm.address,
                                city: this.checkoutForm.city,
                                postal_code: this.checkoutForm.cap,
                                country: 'IT'
                            }
                        },
                    });
                    
                    if (error) {
                        this.showNotification(`Errore pagamento: ${error.message}`, 'error');
                        this.isProcessing = false;
                        return;
                    }
                    
                    // In una vera implementazione, qui invieresti il paymentMethod.id al tuo server
                    // per completare il pagamento. Per questo esempio, simuliamo il successo:
                    
                    setTimeout(() => {
                        this.completeOrder({
                            paymentMethod: 'stripe',
                            transactionId: 'pi_' + Date.now(), // ID transazione simulato
                            stripePaymentMethodId: paymentMethod.id
                        });
                    }, 2000);
                },
                processBankTransfer() {
                    // Per il bonifico bancario, generiamo le istruzioni
                    setTimeout(() => {
                        const order = this.createOrderData();
                        order.paymentInstructions = {
                            method: 'bank_transfer',
                            bankDetails: {
                                bankName: 'Banca Esempio S.p.A.',
                                iban: 'IT60 X054 2811 1010 0000 0123 456',
                                bic: 'BCITITMM',
                                recipient: 'MTA Social Hub S.r.l.',
                                reference: `ORD-${order.id}`
                            }
                        };
                        
                        this.saveOrder(order);
                        this.cartItems = [];
                        this.saveCart();
                        this.resetCheckoutForm();
                        
                        this.showNotification(`Ordine creato! ID: ${order.id}. Riceverai le istruzioni per il bonifico via email.`, 'success');
                        this.isProcessing = false;
                        
                        setTimeout(() => {
                            this.showProducts();
                        }, 4000);
                    }, 1500);
                },
                completeOrder(paymentData) {
                    const order = this.createOrderData();
                    order.payment = paymentData;
                    order.status = 'Pagato';
                    
                    this.saveOrder(order);
                    this.cartItems = [];
                    this.saveCart();
                    this.resetCheckoutForm();
                    
                    let message = '';
                    if (paymentData.paymentMethod === 'stripe') {
                        message = `Pagamento completato! Ordine ID: ${order.id}. Riceverai conferma via email.`;
                    } else if (paymentData.paymentMethod === 'paypal') {
                        message = `Pagamento PayPal completato! Ordine ID: ${order.id}. Grazie ${paymentData.payerName}!`;
                    }
                    
                    this.showNotification(message, 'success');
                    this.isProcessing = false;
                    
                    setTimeout(() => {
                        this.showProducts();
                    }, 3000);
                },
                createOrderData() {
                    return {
                        id: Date.now(),
                        items: [...this.cartItems],
                        total: this.cartTotal,
                        customerInfo: {...this.checkoutForm},
                        date: new Date().toLocaleString('it-IT'),
                        status: 'In elaborazione'
                    };
                },
                validateCheckoutForm() {
                    const form = this.checkoutForm;
                    
                    // Validazione campi obbligatori di base
                    if (!form.firstName || !form.lastName || !form.email || !form.phone) {
                        this.showNotification('Per favore compila tutti i campi obbligatori', 'error');
                        return false;
                    }
                    
                    // Validazione indirizzo solo per consegna a domicilio
                    if (form.deliveryMethod === 'delivery') {
                        if (!form.address || !form.city || !form.cap) {
                            this.showNotification('Per la consegna a domicilio compila indirizzo, citt√† e CAP', 'error');
                            return false;
                        }
                        
                        // Validazione CAP (5 cifre) solo per consegna
                        if (!/^\d{5}$/.test(form.cap)) {
                            this.showNotification('Il CAP deve essere di 5 cifre', 'error');
                            return false;
                        }
                    }
                    
                    // Validazione email
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(form.email)) {
                        this.showNotification('Inserisci un indirizzo email valido', 'error');
                        return false;
                    }
                    
                    // Validazione specifica per metodi di pagamento
                    if (form.paymentMethod === 'stripe') {
                        // Stripe gestisce la validazione internamente
                        if (!this.stripeCard) {
                            this.showNotification('Servizio di pagamento non disponibile. Ricarica la pagina.', 'error');
                            return false;
                        }
                    } else if (form.paymentMethod === 'paypal') {
                        // PayPal gestisce tutto internamente, nessuna validazione necessaria qui
                    } else if (form.paymentMethod === 'bank') {
                        if (!form.bankName || !form.iban) {
                            this.showNotification('Per favore seleziona la banca e inserisci l\'IBAN', 'error');
                            return false;
                        }
                        
                        if (form.bankName === 'other' && !form.customBankName) {
                            this.showNotification('Per favore inserisci il nome della tua banca', 'error');
                            return false;
                        }
                        
                        // Validazione IBAN (formato italiano base)
                        const ibanClean = form.iban.replace(/\s/g, '').toUpperCase();
                        if (!ibanClean.startsWith('IT') || ibanClean.length !== 27) {
                            this.showNotification('Inserisci un IBAN italiano valido (27 caratteri)', 'error');
                            return false;
                        }
                        
                        if (!/^IT\d{2}[A-Z]\d{3}\d{4}\d{12}$/.test(ibanClean)) {
                            this.showNotification('Formato IBAN non valido', 'error');
                            return false;
                        }
                    }
                    
                    return true;
                },
                formatIban() {
                    let value = this.checkoutForm.iban.replace(/\s/g, '').toUpperCase();
                    // Formatta IBAN con spazi ogni 4 caratteri
                    let formattedValue = value.replace(/(.{4})/g, '$1 ').trim();
                    this.checkoutForm.iban = formattedValue;
                },
                resetCheckoutForm() {
                    this.checkoutForm = {
                        firstName: '',
                        lastName: '',
                        email: '',
                        phone: '',
                        address: '',
                        city: '',
                        cap: '',
                        deliveryMethod: 'delivery',
                        paymentMethod: 'stripe',
                        bankName: '',
                        customBankName: '',
                        iban: ''
                    };
                    
                    // Reset dei servizi di pagamento
                    this.paypalRendered = false;
                    if (this.stripeCard) {
                        this.stripeCard.clear();
                    }
                },
                saveOrder(order) {
                    let orders = JSON.parse(localStorage.getItem('mtaOrders') || '[]');
                    orders.push(order);
                    localStorage.setItem('mtaOrders', JSON.stringify(orders));
                },
                initializePage() {
                    // Determina la pagina corrente dal URL
                    const currentURL = window.location.pathname;
                    if (currentURL.includes('carrello')) {
                        this.currentPage = 'cart';
                    } else if (currentURL.includes('checkout')) {
                        this.currentPage = 'checkout';
                    } else {
                        this.currentPage = 'products';
                    }
                }
            },
            mounted() {
                this.loadProducts();
                this.loadCart();
                this.initializePage();
                
                // Gestisce il pulsante indietro del browser
                window.addEventListener('popstate', () => {
                    this.initializePage();
                });
            }
        }).mount('#app');
    </script>
</body>
</html>